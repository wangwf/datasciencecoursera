---
title: "(Kaggle) Use the ATLAS experiment to identify the Higgs boson"
output: html_document
---
## Bike Sharing Demand


## Data Fields



## Load data
```{r, echo=FALSE}
getwd()
setwd("/home/wenfeng/code/datasciencecoursera/kaggle/higgs")
```

```{r loaddata, echo=TRUE}
trainSet <- read.csv("training.csv")
testSet  <- read.csv("test.csv")
dim(trainSet)
dim(testSet)
names(trainSet)
names(testSet)
```

```{r datasummary}
str(trainSet)
summary(trainSet)
```



## Explore data
```{r dataExplore}
hist(trainSet$EventId)
hist(trainSet$DER_mass_MMC,breaks = 100)
hist(trainSet$DER_mass_transverse_met_lep,breaks = 100))

```

Correlation Matrix
```{r corrlationMatrix}
round(cor(trainSet[,-1]),3)
```

SeasonDependecen
```{r seasonDependence}
library(ggplot2)
library(gridExtra)
qplot(x=count, data=trainSet, fill=as.factor(season))
p1 <- qplot(x=count, data=trainSet, fill=as.factor(season)) + scale_x_sqrt()
p2 <- qplot(x=casual, data=trainSet, fill=as.factor(season))+scale_x_sqrt()
p3 <- qplot(x=registered, data=trainSet, fill=as.factor(season))+scale_x_sqrt()

grid.arrange(p1,p2,p3)
```


```{r holidayDependence}
qplot(x=count, data=trainSet, fill=as.factor(holiday))
p1 <- qplot(x=count, data=trainSet, fill=as.factor(holiday)) + scale_x_sqrt()
p2 <- qplot(x=casual, data=trainSet, fill=as.factor(holiday))+scale_x_sqrt()
p3 <- qplot(x=registered, data=trainSet, fill=as.factor(holiday))+scale_x_sqrt()

grid.arrange(p1,p2,p3)
```


```{r weatherDependence}
qplot(x=count, data=trainSet, fill=as.factor(weather))
p1 <- qplot(x=count, data=trainSet, fill=as.factor(weather)) + scale_x_sqrt()
p2 <- qplot(x=casual, data=trainSet, fill=as.factor(weather))+scale_x_sqrt()
p3 <- qplot(x=registered, data=trainSet, fill=as.factor(weather))+scale_x_sqrt()
grid.arrange(p1,p2,p3)
```


```{r tempDependence}
ggplot(aes(x=temp, y=count), data=trainSet)+geom_jitter()+geom_smooth(method="lm", color="blue")
cor(trainSet$count, trainSet$temp)
cor(trainSet$casual, trainSet$temp)
cor(trainSet$registered, trainSet$temp)
```

```{r corTemp}
cor.test(trainSet$temp, trainSet$atemp)
```


```{r humidityDependence}
ggplot(aes(x=humidity, y=count), data=trainSet)+geom_jitter()+geom_smooth(method="lm", color="blue")
cor(trainSet$count, trainSet$humidity)
 cor(trainSet$casual, trainSet$humidity)
cor(trainSet$registered, trainSet$humidity)
```


```{r windspeedDependence}
ggplot(aes(x=windspeed, y=count), data=trainSet)+geom_jitter()+geom_smooth(method="lm", color="blue")
cor(trainSet$count, trainSet$windspeed)
cor(trainSet$casual, trainSet$windspeed)
cor(trainSet$registered, trainSet$windspeed)
```


 ### Features
 Converting datetime from factor to datetime variable, then split on date and time.

```{r variableConvert}
trainSet$date <- strftime(trainSet$datetime, format="%Y-%m-%d")
trainSet$year <- strftime(trainSet$datetime, format="%Y")
trainSet$month <- strftime(trainSet$datetime, format="%m")
trainSet$weekday <- weekdays(as.Date(trainSet$date, format="%Y-%m-%d"))
trainSet$hour <- strftime(trainSet$datetime, format="%H")

trainSet<- transform(trainSet, season=factor(season), holiday=factor(holiday), workingday=factor(workingday), weather=factor(weather),hour=factor(hour))
trainSet<- transform(trainSet, year=factor(year), month=factor(month),weekday=factor(weekday))

testSet$date <- strftime(testSet$datetime, format="%Y-%m-%d")
testSet$hour <- strftime(testSet$datetime, format="%H")
testSet$year <- strftime(testSet$datetime, format="%Y")
testSet$month <- strftime(testSet$datetime, format="%m")
testSet$weekday <- weekdays(as.Date(testSet$datetime, format="%Y-%m-%d"))
testSet<- transform(testSet, season=factor(season), holiday=factor(holiday), workingday=factor(workingday), weather=factor(weather),hour=factor(hour))
testSet<- transform(testSet, year=factor(year), month=factor(month),weekday=factor(weekday))
```

```{r}
trainSet$season    <- factor(trainSet$season, c(1,2,3,4), ordered=FALSE)
trainSet$holiday   <- factor(trainSet$holiday, c(0,1), ordered=FALSE)
trainSet$workingday<- factor(trainSet$workingday, c(0,1), ordered=FALSE)
trainSet$weather   <- factor(trainSet$weather, c(4,3,2,1), ordered=TRUE)

testSet$season    <- factor(testSet$season, c(1,2,3,4), ordered=FALSE)
testSet$holiday   <- factor(testSet$holiday, c(0,1), ordered=FALSE)
testSet$workingday<- factor(testSet$workingday, c(0,1), ordered=FALSE)
testSet$weather   <- factor(testSet$weather, c(4,3,2,1), ordered=TRUE)

```

```{r functions, echo=FALSE}
outputFile<-function(p){
    output <- subset(testSet, select='datetime')
    output$count<-p
    outname <- paste0('results/out_', format(Sys.time(), "%y%m%d_%H%M%S"),".csv")
    write.csv(output,outname, quote=FALSE, row.names=FALSE)
    }

BikeEva <- function(data, pred){
    pred[pred<0]<-0
    return(sqrt(1/length(data) * sum((log(pred + 1) - log(data+1))^2)))
}
```



## Train models

```{r sampleSplit}
library(caret)
ind <- createDataPartition(y=trainSet$count, p=0.7, list=F)
mytrainSet <- trainSet[ind,]
mytestSet  <- trainSet[-ind,]

```

### Linear Model
```{r model1}
lm1 <-lm(count ~temp+humidity+hour, data=mytrainSet)
p<-round(predict(lm1, newdata=mytestSet))
BikeEva(mytestSet$count,p)
library(caret)
#lm2 <-lm(count ~ ., data=trainSet, method="lm") #
lm2 <- train(count ~temp + humidity + hour, data=mytrainSet, method="lm")
p<-round(predict(lm2, newdata=mytestSet))
BikeEva(mytestSet$count,p)
```


```{r linearModel}
library(caret)
f1 <- formula(log(casual+1)     ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour + year+month+weekday)
f2 <- formula(log(registered+1) ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour + year+month+weekday)
#f1 <- formula(log(casual+1)     ~ season+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour)
#f2 <- formula(log(registered+1) ~ season+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour)
lm11 <- lm(f1, data=mytrainSet)
lm12 <- lm(f2, data=mytrainSet)

p1 <- predict(lm11, newdata=mytestSet) #trainSet)
p2 <- predict(lm12, newdata=mytestSet) #trainSet)
p12 <- round(exp(p1) + exp(p2)-2)
BikeEva(mytestSet$count, p12)
```


gbm
```{r gbmModel}
library(caret)
gbm1 <- train(f1, data=mytrainSet, method="bstTree")
gbm2 <- train(f2, data=mytrainSet, method="bstTree")
#gbm1 <- gbm(f1, data=mytrainSet)
#gbm2 <- gbm(f2, data=mytrainSet)

p1<-round(predict(gbm1, newdata=mytestSet))
p2<-round(predict(gbm2, newdata=mytestSet))
p12 <- round(exp(p1) + exp(p2)-2)
BikeEva(mytestSet$count, p12)
```
0.5710 not worth to submit
0.5140 


```{r cubistModel}
#f1 <- formula(log(casual+1)     ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour )
#f2 <- formula(log(registered+1) ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour )

f1 <- formula(log(casual+1)     ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + year+month+weekday+hour + I(temp^2)+I(atemp^2) + I(humidity^2) + I(windspeed^2))
f2 <- formula(log(registered+1) ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + year+month+weekday+hour + I(temp^2)+I(atemp^2) + I(humidity^2) + I(windspeed^2))

#modelgbm <- train(count~.+ I(atemp^2) + I(hour^2), data=trainSet, method="cubist")
#p<-round(predict(modelgbm, newdata=trainSet))
#BikeEva(trainSet$count,p)

cub1 <- train(f1, data=mytrainSet, method="cubist")
cub2 <- train(f2, data=mytrainSet, method="cubist")
#gbm1 <- gbm(f1, data=mytrainSet)
#gbm2 <- gbm(f2, data=mytrainSet)
p1<- predict(cub1, newdata=mytestSet)
p2<- predict(cub2, newdata=mytestSet)
p12 <- round(exp(p1) + exp(p2)-2)
BikeEva(mytestSet$count, p12)

```
0.412 rank 54 kaggle score 0.43308
0.3060991 rank 11th kaggle score 0.39199
 
```{r cubistOUt}
pt1 <- predict(cub1, newdata=testSet)
pt2 <- predict(cub2, newdata=testSet)
pt12 <- round(exp(pt1) + exp(pt2)-2)
outputFile(pt12)
```

### rpart
```{r rpartModel}
library(rpart)
#ff <- formula(count ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour)

rpart1 <- rpart(f1, data=mytrainSet)
rpart2 <- rpart(f2, data=mytrainSet)

p1<- predict(rpart1, newdata=mytestSet)
p2<- predict(rpart2, newdata=mytestSet)
p12 <- round(exp(p1) + exp(p2)-2)

plot(mytestSet$count, p12)
BikeEva(mytestSet$count,p12)

ptest<- round(predict(modelRpart, newdata=testSet))
outputFile(ptest)
```
0.683 not a improve

### Random Forest Models

```{r rf2}
library(randomForest)
f1 <- formula(log(casual+1)     ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour+year+month+weekday )
f2 <- formula(log(registered+1) ~ season+ holiday+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour +year+month+weekday)
#f1 <- formula(log(casual+1)     ~ season+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour)
#f2 <- formula(log(registered+1) ~ season+ workingday+ weather+ temp+ atemp+  humidity +windspeed + hour)
rfmodel1 <- randomForest(f1, data=mytrainSet)
importance(rfmodel1)
rfmodel2 <- randomForest(f2, data=mytrainSet)
importance(rfmodel2)

p1 <- predict(rfmodel1, newdata=mytestSet) #trainSet)
p2 <- predict(rfmodel2, newdata=mytestSet) #trainSet)
#p12 <- round(10^p1 + 10^p2 -2)
p12 <- round(exp(p1) + exp(p2)-2)
BikeEva(mytestSet$count, p12)
```
0.418, 0.3987 (with hour^2)
0.360 (with year, month and weekday)

```{r output2}
pt1 <- predict(rfmodel1, newdata=testSet)
pt2 <- predict(rfmodel2, newdata=testSet)
pt12 <- round(exp(pt1) + exp(pt2)-2)
outputFile(pt12)

```
submitted  (0..


RWeka packages failed
```{r RWeka}
library(RWeka)
mod1 <- M5P(f1, data=mytrainSet)
mod2 <- M5P(f2, data=mytrainSet)
p1 <- predict(mod1, newdata=mytestSet)
p2 <- predict(mod2, newdata=mytestSet)
p12 <- round(exp(p1) + exp(p2)-2)
BikeEva(trainSet$count, p12)
```
